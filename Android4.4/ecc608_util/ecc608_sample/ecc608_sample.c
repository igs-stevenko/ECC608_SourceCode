#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/ioctl.h>
#include <unistd.h>
#include <sys/time.h>

#include "libecc608_api.h"

int main(void){

	int rtn = 0;
	unsigned char cmd;

	unsigned char game_priv_key[32] = {
		
		/*
		0x22, 0xBD, 0x5B, 0xA4, 0xF1, 0x4B, 0xBA, 0xA8, 
		0x29, 0xE3, 0x0E, 0x69, 0x47, 0x55, 0x34, 0xAE,
		0xCA, 0xB5, 0x07, 0x89, 0xF7, 0xC1, 0x03, 0xEB, 
		0x0D, 0x71, 0x62, 0xDA, 0x23, 0xAB, 0x8E, 0xF0
		*/
		
		0x3a,0x55,0xd1,0x09,0x7b,0x1a,0x7e,0xa6,
		0xbb,0xe1,0xfe,0x20,0x75,0xb5,0xc9,0x1a,
		0xdf,0xf6,0x93,0x22,0x52,0xf6,0x74,0x75,
		0x58,0xbd,0x58,0x62,0x10,0x82,0xc0,0x92
		
	};

	unsigned char game_pub_key[64] = {
		
		/*
		0xA3, 0xD3, 0xAF, 0x4E, 0xF8, 0x68, 0xAE, 0x83, 
		0xAB, 0x2C, 0x34, 0xF1, 0x3D, 0xEC, 0xBE, 0x4C,
		0x8C, 0xF1, 0xC1, 0x6E, 0x73, 0xC6, 0xC1, 0xFE, 
		0x0F, 0xF4, 0x7C, 0xE7, 0x3D, 0xAB, 0xF1, 0xE1,
		0x08, 0x53, 0xCB, 0xD7, 0x88, 0xD4, 0xE2, 0x37, 
		0xE9, 0x53, 0xD5, 0xAD, 0x18, 0x7B, 0xC2, 0xA1,
		0x01, 0xC5, 0xD0, 0x58, 0xC0, 0x49, 0xBD, 0xDA, 
		0x77, 0xA0, 0x4C, 0xE0, 0x2C, 0x0F, 0x4A, 0x6C
		*/

		/*	
		0xe6,0x14,0x8c,0xda,0xae,0xdf,0x81,0x59,
		0xd2,0xd7,0xc0,0xd6,0x49,0x55,0xcf,0x46,
		0xed,0xf8,0x3e,0xae,0xf3,0xcc,0x11,0x3f,
		0x78,0x2f,0x0a,0x01,0x09,0xb5,0xe5,0xfa,
		0x83,0x9e,0xb6,0xd6,0xb7,0x91,0x92,0xe3,
		0xc1,0x75,0x20,0x2a,0xdb,0x48,0x51,0xae,
		0x35,0xf5,0x87,0x85,0xc1,0x95,0xd9,0xdc,
		0x59,0x29,0xab,0x8a,0x96,0x35,0x01,0xcd
		*/

		
		0xE6,0x14,0x8C,0xDA,0xAE,0xDF,0x81,0x59,
		0xD2,0xD7,0xC0,0xD6,0x49,0x55,0xCF,0x46,
		0xED,0xF8,0x3E,0xAE,0xF3,0xCC,0x11,0x3F,
		0x78,0x2F,0x0A,0x01,0x09,0xB5,0xE5,0xFA,
		0x83,0x9E,0xB6,0xD6,0xB7,0x91,0x92,0xE3,
		0xC1,0x75,0x20,0x2A,0xDB,0x48,0x51,0xAE,
		0x35,0xF5,0x87,0x85,0xC1,0x95,0xD9,0xDC,
		0x59,0x29,0xAB,0x8A,0x96,0x35,0x01,0xCD
		
	};

	unsigned char external_priv_key[32] = {
		0x5a, 0xca, 0xdd, 0x48, 0xaa, 0x16, 0x46, 0xee,
		0x76, 0x78, 0xeb, 0xd2, 0x69, 0xc4, 0x6e, 0x09,
		0x20, 0x2c, 0x95, 0x86, 0x8b, 0x98, 0x9a, 0xec, 
		0xed, 0x98, 0x85, 0xe3, 0x80, 0xe4, 0xdd, 0xfa
	};

	unsigned char external_pub_key[64] = {
		0x00,0x3e,0x26,0x72,0x2c,0xb9,0x86,0x80,
		0xc7,0x16,0x65,0xa2,0x8b,0x40,0xae,0x68,
		0xe5,0x3b,0x09,0x17,0xe5,0x63,0x73,0x9b,
		0xa4,0xcd,0xfd,0x47,0xc0,0x2a,0x80,0x38,
		0x3d,0x57,0x74,0x5d,0xd6,0x20,0x59,0xc7,
		0xb5,0x55,0x07,0xbf,0xb4,0xb7,0x1d,0xe3,
		0xe6,0x8e,0xe9,0xa0,0x92,0xf9,0xc2,0x20,
		0x89,0x2e,0xf6,0x61,0xc7,0x40,0xf0,0xdb
	};

	printf("a. Set config\n");
	printf("b. Set game key\n");
	printf("c. Lock data zone\n");
	printf("d. Game authentication\n");
	printf("e. Game authentication Loop\n");
	printf("f. ecc608_check_lock_status\n");
	printf("\n");

	cmd = getchar();
	switch(cmd){
	
		case 'a':
			rtn = set_config();
			if(rtn != CMD_SUCCESS){
				printf("==> set config failed, rtn = %d\n", rtn);
			}
			else{
				printf("==> set config success\n");
			}
			break;
	
		case 'b':
			rtn = set_gamekey(game_priv_key);
			if(rtn != CMD_SUCCESS){
				printf("==> set game key failed, rtn = %d\n", rtn);
			}
			else{
				printf("==> set game key success\n");
			}
			break;
		case 'c':
			rtn = lock_data_zone();
			if(rtn != CMD_SUCCESS){
				printf("==> lock data zone failed, rtn = %d\n", rtn);
			}
			else{
				printf("==> lock data zone success\n");
			}
			
			break;
		
		case 'd':
		{
			struct timeval begin;
			struct timeval end;
			unsigned int cost = 0;

			gettimeofday(&begin, NULL);
			rtn = authentication_game(game_pub_key);
			gettimeofday(&end, NULL);
			if(rtn != CMD_SUCCESS){
				//printf("==> authentication failed, rtn = %d\n", rtn);
			}
			else{
				//cost = 1000000 * (end.tv_sec-begin.tv_sec)+ end.tv_usec-begin.tv_usec;
				//printf("==> authentication success, cost = %ld\n", cost);
			}
			break;
		}

		case 'e':
		{
			unsigned int count = 0;
			struct timeval begin;
			struct timeval end;
			unsigned int cost = 0;

			while(1){
				//gettimeofday(&begin, NULL);
				//sleep(1);
				//printf("#\n"); 
				//count++;
				//usleep(5000);
				rtn = authentication_game(game_pub_key);
				//gettimeofday(&end, NULL);
				if(rtn != CMD_SUCCESS){
					printf("==> authentication failed, rtn = %d, count = %d\n", rtn, count);
					break;
				}
				else{
					//cost = 1000000 * (end.tv_sec-begin.tv_sec)+ end.tv_usec-begin.tv_usec;
					//printf("==> authentication success, count = %d, cost = %ld\n", count, cost);
					printf("### [%s][%d] count = %ld ###\n", __func__, __LINE__, count); 
				}

				count++;

				//sleep(3);
			}
			break;
		}
	
		case 'f':
		{
			unsigned char config_zone = -1;
			unsigned char data_zone = -1;
			rtn = ecc608_check_lock_status(&config_zone, &data_zone);

			if(rtn < 0){
				printf("==> ecc608_check_lock_status failed\n");
			}
			else{
				printf("==> config_zone = 0x%02x, data_zone = 0x%02x\n",
							config_zone, data_zone);
			}
			break;
		}

		/*
		case 'e':
		{
			unsigned int count = 0;

			while(1){
				
				rtn = authentication_system(system_pub_key);
				if(rtn != CMD_SUCCESS){
					printf("==> authentication failed, rtn = %d, count = %d\n", rtn, count);
					break;
				}
				else{
					printf("==> authentication success, count = %d\n", count);
				}
				
				count++;

				sleep(1);
			}
			break;
		}
		case 'f':
		{
			rtn = activation_OLD(external_priv_key);
			if(rtn != CMD_SUCCESS){
				printf("==> activation failed, rtn = %d\n", rtn);
			}
			else{
				printf("==> activation external key success\n");
			}
			break;
		}
		case 'g':
		{
			rtn = authentication_system(external_pub_key);
			if(rtn != CMD_SUCCESS){
				printf("==> authentication failed, rtn = %d\n", rtn);
			}
			else{
				printf("==> authentication external key success\n");
			}

			break;
		}
		case 'i':
		{
			unsigned int count = 0;
			struct timeval begin;
			struct timeval end;
			unsigned int cost = 0;

			while(1){
				
				gettimeofday(&begin, NULL);
				rtn = authentication_system(external_pub_key);
				gettimeofday(&end, NULL);
				if(rtn != CMD_SUCCESS){
					printf("==> authentication failed, rtn = %d, count = %d\n", rtn, count);
					break;
				}
				else{
					cost = 1000000 * (end.tv_sec-begin.tv_sec)+ end.tv_usec-begin.tv_usec;
					printf("==> authentication success, count = %d, cost = %ld\n", count, cost);
				}
				
				count++;

				sleep(1);
			}
			break;
		}
		*/

		default:
			printf("Input cmd error\n");
			exit(1);
			break;
	}

	return 0;

}

